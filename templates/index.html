<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Quizroom Academy</title>

<!-- Tailwind + Chart.js -->
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
  :root{
    --glass-bg: rgba(255,255,255,0.14);
    --glass-border: rgba(255,255,255,0.18);
    --card-radius: 14px;
  }
  body { font-family: 'Inter', sans-serif; min-height: 100vh; margin:0; }

  /* Animated gradient background */
  .bg-animated { background-size: 300% 300%; animation: gradientMove 12s linear infinite; }
  @keyframes gradientMove {
    0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}
  }

  /* Glass card */
  .glass {
    background: var(--glass-bg);
    border: 1px solid var(--glass-border);
    backdrop-filter: blur(10px) saturate(120%);
    -webkit-backdrop-filter: blur(10px) saturate(120%);
    border-radius: var(--card-radius);
  }

  /* Card hover */
  .card-hover:hover { transform: translateY(-6px) scale(1.01); transition: transform .22s ease; }

  /* Option button styling */
  .option-btn {
    display:flex; align-items:center; gap:0.6rem;
    border-radius:10px;
    padding:10px 12px;
    cursor:pointer;
    user-select:none;
    transition: transform .12s ease, background-color .12s ease, box-shadow .12s ease;
  }
  .option-btn:hover { transform: translateY(-3px); box-shadow: 0 6px 18px rgba(0,0,0,0.06); }

  /* Selected and correct/incorrect states */
  .option-selected { background: rgba(59,130,246,0.08); border: 1px solid rgba(59,130,246,0.18); }
  .option-correct { background: rgba(16,185,129,0.08); border: 1px solid rgba(16,185,129,0.16); }
  .option-wrong { background: rgba(239,68,68,0.06); border: 1px solid rgba(239,68,68,0.14); }

  /* small helpers */
  .shadow-soft { box-shadow: 0 6px 20px rgba(2,6,23,0.06); }
  .badge-anim { animation: bounce 1.1s infinite; }
  @keyframes bounce { 0%,100%{transform:translateY(0);}50%{transform:translateY(-6px);} }

  /* responsive adjustments */
  @media (min-width: 992px) {
    .layout-grid { display:grid; grid-template-columns: 1fr 340px; gap:22px; align-items:start; }
  }
  @media (max-width: 991px) {
    .layout-grid { display:block; }
  }

  /* ad placeholder */
  .ad-slot { min-height:60px; border:2px dashed rgba(255,255,255,0.12); display:flex; align-items:center; justify-content:center; color:rgba(255,255,255,0.7); border-radius:10px;}
</style>
</head>
<body class="bg-animated" id="pageBody">

<!-- Top navbar -->
<header class="w-full glass sticky top-0 z-50">
  <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <!-- Logo -->
      <div class="w-10 h-10 rounded-lg bg-white/10 flex items-center justify-center">
        <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="white"><path d="M4 6h16M4 12h10M4 18h16" stroke-width="1.5" stroke-linecap="round"></path></svg>
      </div>
      <div class="text-white">
        <div class="text-lg font-semibold">Quizroom Academy</div>
        <div class="text-xs opacity-80">Smart MCQ practice â€¢ multi-exam</div>
      </div>
    </div>

    <div class="flex items-center gap-3">
      <button id="themeToggle" class="px-3 py-1 rounded-md text-sm glass text-white">Toggle Theme</button>
      <div id="bookmarkCounter" class="text-white text-sm opacity-90 hidden">ðŸ”– <span id="bmCount">0</span></div>
    </div>
  </div>
</header>

<main class="max-w-6xl mx-auto p-4 mt-6">
  <!-- container with left question area + right sidebar -->
  <div class="layout-grid">

    <!-- LEFT: Quiz area -->
    <section class="space-y-4">

      <!-- exam selector card -->
      <div class="glass p-4 card-hover shadow-soft">
        <div class="flex flex-wrap gap-3 items-center">
          <div class="text-white font-semibold">Exam</div>
          <select id="examSelect" class="px-3 py-2 rounded-md text-black">
            <option value="upsc">UPSC</option>
            <option value="neet_pg">NEET PG</option>
            <option value="ssc">SSC</option>
          </select>

          <div class="text-white font-semibold">Year / Topic</div>
          <select id="subtopicSelect" class="px-3 py-2 rounded-md text-black"></select>

          <button id="loadBtn" class="ml-auto bg-white text-black px-4 py-2 rounded-md font-semibold">Load Quiz</button>
        </div>
      </div>

      <!-- big quiz card -->
      <div id="quizPanel" class="glass p-5 rounded-xl shadow-soft">
        <!-- header: progress + small controls -->
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center gap-3">
            <div id="liveScore" class="text-white font-bold text-lg">Score: 0</div>
            <div class="text-white/80 text-sm">â€¢</div>
            <div id="progressText" class="text-white/80 text-sm">0 / 0 answered</div>
          </div>

          <div class="flex items-center gap-2">
            <button id="audioToggle" title="Toggle audio" class="px-2 py-1 rounded bg-white/10 text-white">ðŸ”Š</button>
            <button id="bookmarkBtn" class="px-3 py-1 bg-yellow-400 rounded hidden">Bookmark</button>
          </div>
        </div>

        <!-- question area -->
        <div id="quizContainer"></div>

        <!-- navigation -->
        <div id="navButtons" class="hidden mt-4 flex items-center justify-between">
          <div>
            <button id="prevBtn" class="px-4 py-2 bg-white/10 rounded text-white">Previous</button>
          </div>
          <div class="flex items-center gap-3">
            <div class="w-56 bg-white/20 h-3 rounded overflow-hidden">
              <div id="progressBar" class="h-3 bg-green-400 w-0"></div>
            </div>
            <button id="nextBtn" class="px-4 py-2 bg-white/10 rounded text-white">Next</button>
          </div>
        </div>

        <!-- submit -->
        <div class="mt-4 text-center">
          <button id="submitBtn" class="hidden bg-gradient-to-r from-green-400 to-teal-500 text-white px-6 py-2 rounded-lg font-semibold">Submit Quiz</button>
        </div>
      </div>

      <!-- small ad placeholder mobile -->
      <div class="mt-4 md:hidden">
        <div class="ad-slot glass p-3">Ad slot (mobile) - placeholder</div>
      </div>
    </section>

    <!-- RIGHT: Sidebar -->
    <aside class="space-y-4">

      <!-- summary card -->
      <div class="glass p-4 rounded-xl shadow-soft">
        <div class="flex items-center justify-between mb-2">
          <h3 class="text-white font-semibold">Quick Controls</h3>
          <div class="text-sm text-white/80">Tip: Tap options to select</div>
        </div>

        <div class="space-y-3">
          <div class="text-white/80 text-sm">Question navigator</div>
          <div id="questionNav" class="flex flex-wrap gap-2"></div>

          <div class="mt-2">
            <div class="text-white/80 text-sm">Bookmarks</div>
            <div id="bookmarkList" class="flex flex-wrap gap-2 mt-2"></div>
          </div>
        </div>
      </div>

      <!-- chart -->
      <div id="topicChartContainer" class="glass p-4 rounded-xl shadow-soft hidden">
        <h3 class="text-white font-semibold mb-2">Topic-wise</h3>
        <canvas id="topicChart"></canvas>
      </div>

      <!-- AI summary -->
      <div id="aiSummaryCard" class="glass p-4 rounded-xl shadow-soft hidden">
        <h3 class="text-white font-semibold mb-2">AI Summary</h3>
        <div id="aiSummaryText" class="text-white/90 text-sm"></div>
      </div>

      <!-- ad placeholder desktop -->
      <div class="hidden md:block">
        <div class="ad-slot p-4 glass">Ad slot (desktop sidebar) - placeholder</div>
      </div>
    </aside>
  </div>
</main>

<script>
/* -------------------------
  Configuration & state
---------------------------*/
let quizData = [], currentQuestion = 0, answers = {}, bookmarks = [];
let audioEnabled = true;
const examSelect = document.getElementById('examSelect');
const subtopicSelect = document.getElementById('subtopicSelect');
const loadBtn = document.getElementById('loadBtn');
const quizContainer = document.getElementById('quizContainer');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const submitBtn = document.getElementById('submitBtn');
const navButtons = document.getElementById('navButtons');
const progressBar = document.getElementById('progressBar');
const liveScore = document.getElementById('liveScore');
const progressText = document.getElementById('progressText');
const bookmarkBtn = document.getElementById('bookmarkBtn');
const bookmarkCounter = document.getElementById('bookmarkCounter');
const bmCount = document.getElementById('bmCount');
const bookmarkList = document.getElementById('bookmarkList');
const questionNav = document.getElementById('questionNav');
const topicChartContainer = document.getElementById('topicChartContainer');
const aiSummaryCard = document.getElementById('aiSummaryCard');
const aiSummaryText = document.getElementById('aiSummaryText');
const audioToggle = document.getElementById('audioToggle');

/* Persist bookmarks and last exam in localStorage */
const STORAGE_KEY = 'quizroom_state_v1';
function saveLocalState(){
  const state = { bookmarks, answers, exam: examSelect.value, subtopic: subtopicSelect.value };
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}
function loadLocalState(){
  try{
    const s = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
    if(s && s.bookmarks) bookmarks = s.bookmarks;
  }catch(e){}
}

/* Background themes */
const examBg = {
  upsc: 'linear-gradient(120deg,#0ea5e9 0%, #3b82f6 40%, #312e81 100%)',
  neet_pg: 'linear-gradient(120deg,#7c3aed 0%, #d946ef 50%, #4c1d95 100%)',
  ssc: 'linear-gradient(120deg,#16a34a 0%, #22c55e 50%, #166534 100%)'
};

/* initially set body bg */
document.getElementById('pageBody').style.background = examBg[examSelect.value];

/* change background when exam changes */
examSelect.addEventListener('change', e => {
  document.getElementById('pageBody').style.background = examBg[e.target.value] || examBg.upsc;
  loadSubtopics();
  // store exam selection
  saveLocalState();
});

/* audio toggle */
audioToggle.onclick = ()=> { audioEnabled = !audioEnabled; audioToggle.style.opacity = audioEnabled? '1':'0.5'; };

/* Load subtopics from backend */
function loadSubtopics(){
  fetch(`/get_subtopics/${examSelect.value}`)
    .then(r => r.json())
    .then(list => {
      subtopicSelect.innerHTML = '';
      if(!list || list.length === 0){
        const opt = document.createElement('option'); opt.value='default'; opt.innerText='default'; subtopicSelect.appendChild(opt);
      } else {
        list.forEach(s => { const opt = document.createElement('option'); opt.value = s; opt.innerText = s; subtopicSelect.appendChild(opt); });
      }
    })
    .catch(()=>{ subtopicSelect.innerHTML = '<option value="default">default</option>'; });
}
window.addEventListener('load', () => { loadSubtopics(); loadLocalBookmarksUI(); });

/* Load quiz */
loadBtn.addEventListener('click', () => {
  fetch(`/get-quiz/${examSelect.value}/${subtopicSelect.value}`)
    .then(r => r.json())
    .then(data => {
      quizData = data || [];
      currentQuestion = 0; answers = {}; // fresh session
      // restore answers/bookmarks from localStorage if present for this exam/subtopic (optional)
      renderQuestion();
      navButtons.classList.remove('hidden');
      submitBtn.classList.remove('hidden');
      bookmarkBtn.classList.remove('hidden');
      renderQuestionNav();
      updateProgress();
    })
    .catch(err => { alert('Failed to load quiz'); console.error(err); });
});


/* Render question card */
function renderQuestion(){
  if(!quizData || quizData.length === 0){
    quizContainer.innerHTML = `<div class="text-white/80">No questions found for this selection.</div>`;
    return;
  }

  const q = quizData[currentQuestion];
  const total = quizData.length;
  // build HTML using option buttons - touch friendly
  let html = `<div class="mb-4">
    <div class="flex items-center justify-between mb-3">
      <div class="text-white font-semibold">Q ${currentQuestion+1} of ${total}</div>
      <div class="text-white/80 text-sm">${q.topic || subtopicSelect.value}</div>
    </div>
    <div class="p-4 rounded-lg glass card-hover shadow-soft">
      <div class="text-white font-medium text-lg mb-3">${escapeHtml(q.question)}</div>`;

  // options
  html += `<div class="grid gap-3">`;
  q.options.forEach((opt, idx) => {
    const sel = answers[currentQuestion] === opt;
    html += `<div class="option-btn ${sel ? 'option-selected' : ''}" data-val="${escapeHtml(opt)}" onclick="selectOption(${currentQuestion}, ${idx})">
      <div class="w-6 h-6 flex items-center justify-center rounded-full bg-white/8 text-white text-sm">${String.fromCharCode(65+idx)}</div>
      <div class="text-white">${escapeHtml(opt)}</div>
    </div>`;
  });
  html += `</div></div></div>`;

  quizContainer.innerHTML = html;
  renderBookmarkState();
  if(audioEnabled) speakText(q.question);
  updateProgress();
}

/* select option handler (exposed to DOM via onclick attr) */
window.selectOption = function(qIndex, optIndex){
  if(!quizData[qIndex]) return;
  answers[qIndex] = quizData[qIndex].options[optIndex];
  renderQuestion();         // re-render to update selected state
  renderQuestionNav();      // update nav
  updateProgress();
  saveLocalState();
};

/* navigation buttons */
prevBtn.addEventListener('click', () => { saveAnswer(); if(currentQuestion>0){ currentQuestion--; renderQuestion(); } });
nextBtn.addEventListener('click', () => { saveAnswer(); if(currentQuestion < quizData.length-1){ currentQuestion++; renderQuestion(); }});

/* save answer for current question (already saved on click) */
function saveAnswer(){ /* answers updated on click */ }

/* progress & live score */
function updateProgress(){
  const answered = Object.keys(answers).length;
  const total = quizData.length || 0;
  progressBar.style.width = total ? ((answered/total)*100)+'%' : '0%';
  progressText.innerText = `${answered} / ${total} answered`;
  // live score compute with available answers
  let score = 0;
  for(let i=0;i<quizData.length;i++){
    if(answers[i] && quizData[i] && answers[i] === quizData[i].answer) score++;
  }
  liveScore.innerText = `Score: ${score} / ${quizData.length}`;
}

/* Bookmark logic */
bookmarkBtn.addEventListener('click', () => {
  if(!bookmarks.includes(currentQuestion)) bookmarks.push(currentQuestion);
  highlightBookmark();
  renderBookmarkUI();
  saveLocalState();
});
function highlightBookmark(){
  if(bookmarks.includes(currentQuestion)) bookmarkBtn.classList.add('bg-yellow-600'); else bookmarkBtn.classList.remove('bg-yellow-600');
}
function renderBookmarkUI(){
  // counter
  const count = bookmarks.length;
  if(count>0){ bookmarkCounter.style.display = 'inline-block'; bmCount.innerText = count; } else { bookmarkCounter.style.display = 'none'; }
  // list
  bookmarkList.innerHTML = '';
  bookmarks.forEach(i=>{
    const el = document.createElement('button');
    el.className = 'px-2 py-1 rounded bg-white/10 text-white text-sm';
    el.innerText = `Q ${i+1}`;
    el.onclick = ()=> { currentQuestion = i; renderQuestion(); };
    bookmarkList.appendChild(el);
  });
}
/* restore from local */
function loadLocalBookmarksUI(){
  loadLocalState();
  renderBookmarkUI();
}

/* render question navigation grid */
function renderQuestionNav(){
  questionNav.innerHTML = '';
  for(let i=0;i<quizData.length;i++){
    const but = document.createElement('button');
    but.className = `px-2 py-1 rounded text-sm ${answers[i] ? 'bg-green-600 text-white' : 'bg-white/10 text-white/80'}`;
    but.innerText = i+1;
    but.onclick = ()=>{ currentQuestion = i; renderQuestion(); };
    questionNav.appendChild(but);
  }
}

/* Submit quiz -> call backend, show results, chart, AI summary */
submitBtn.addEventListener('click', ()=>{
  // ensure last answer saved
  saveAnswer();
  fetch(`/submit/${examSelect.value}/${subtopicSelect.value}`, {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify(answers)
  }).then(r => r.json())
    .then(resp => {
      // render colored result cards
      renderResultCards(resp);
      // show topic chart
      renderTopicChart(resp.incorrect_questions);
      // show AI summary
      aiSummaryText.innerText = resp.ai_summary || 'No summary available.';
      aiSummaryCard.classList.remove('hidden');
      // scroll to results
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }).catch(err => {
      console.error(err); alert('Submit failed.');
    });
});

/* draw result cards */
function renderResultCards(resp){
  quizContainer.innerHTML = '';
  for(let i=0;i<quizData.length;i++){
    const q = quizData[i];
    const user = answers[i] || 'Not Answered';
    const correct = q.answer;
    const isCorrect = user === correct;
    const colorClass = isCorrect ? 'bg-white/6 border-l-4 border-green-400' : 'bg-white/6 border-l-4 border-red-400';
    const block = document.createElement('div');
    block.className = `p-4 rounded mb-3 ${colorClass} glass`;
    block.innerHTML = `<div class="flex justify-between items-start">
        <div class="font-semibold text-white">Q ${i+1}: ${escapeHtml(q.question)}</div>
        <div class="text-sm text-white/80">${isCorrect ? 'Correct' : 'Incorrect'}</div>
      </div>
      <div class="mt-2 text-white/90">Your answer: <strong>${escapeHtml(user)}</strong></div>
      <div class="mt-1 text-white/80">Correct answer: <strong>${escapeHtml(correct)}</strong></div>`;
    quizContainer.appendChild(block);
  }
  // hide nav & submit
  navButtons.classList.add('hidden');
  submitBtn.classList.add('hidden');
}

/* Topic chart: counts incorrect by topic (fallback to subtopic name) */
let chartInstance = null;
function renderTopicChart(incorrectQuestions){
  // build counts (all assigned to current subtopic for now)
  const topicCounts = {};
  if(!quizData || quizData.length === 0) return;
  const key = subtopicSelect.value || 'topic';
  topicCounts[key] = incorrectQuestions.length || 0;

  // prepare data
  const labels = Object.keys(topicCounts);
  const data = Object.values(topicCounts);

  // destroy old chart
  if(chartInstance) chartInstance.destroy();
  const ctx = document.getElementById('topicChart').getContext('2d');
  chartInstance = new Chart(ctx, {
    type: 'bar',
    data: { labels, datasets: [{ label: 'Incorrect', data, backgroundColor: 'rgba(255,99,132,0.7)' }] },
    options: { responsive: true, plugins: { legend: { display: false } } }
  });
  topicChartContainer.classList.remove('hidden');
}

/* Simple TTS */
function speakText(text){
  if(!('speechSynthesis' in window)) return;
  try {
    window.speechSynthesis.cancel(); // stop previous
    const u = new SpeechSynthesisUtterance(text);
    u.lang = 'en-US';
    u.rate = 0.95;
    window.speechSynthesis.speak(u);
  } catch(e){ console.warn(e); }
}

/* small utility to escape HTML content */
function escapeHtml(str){ if(!str && str !== 0) return ''; return String(str).replace(/[&<>"'`=\/]/g, function(s){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'}[s]; }); }

/* Keyboard shortcuts for navigation (left/right) */
document.addEventListener('keydown', (e)=>{
  if(e.key === 'ArrowLeft') prevBtn.click();
  if(e.key === 'ArrowRight') nextBtn.click();
  if(e.key === 'b' || e.key === 'B') bookmarkBtn.click();
});

/* Save local when leaving page */
window.addEventListener('beforeunload', saveLocalState);
</script>

</body>
</html>
