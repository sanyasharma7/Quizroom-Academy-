<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Quizroom Academy</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
body { font-family: 'Inter', sans-serif; }
.card:hover { transform: scale(1.03); transition: all 0.3s ease; }
.badge { animation: bounce 1s infinite; }
@keyframes bounce { 0%,100%{transform:translateY(0);}50%{transform:translateY(-8px);} }
</style>
</head>
<body class="bg-gray-50 p-6">

<div class="max-w-5xl mx-auto bg-white p-6 rounded-xl shadow-lg">

<h1 class="text-4xl font-bold text-center mb-6 text-blue-700">Quizroom Academy</h1>

<!-- Exam & Subtopic Selection -->
<div class="mb-4 text-center flex flex-wrap justify-center items-center gap-3">
  <label class="font-semibold">Select Exam:</label>
  <select id="examSelect" class="border rounded px-3 py-1">
    <option value="upsc">UPSC</option>
    <option value="neet_pg">NEET PG</option>
    <option value="ssc">SSC</option>
  </select>

  <label class="font-semibold ml-2">Select Year / Topic:</label>
  <select id="subtopicSelect" class="border rounded px-3 py-1"></select>

  <button id="loadBtn" class="bg-blue-500 text-white px-4 py-1 rounded hover:bg-blue-600">Load Quiz</button>
</div>

<!-- Live Score & Progress -->
<div class="flex justify-between items-center mb-4">
  <div id="liveScore" class="text-lg font-semibold text-blue-700">Score: 0</div>
  <div class="w-1/2 bg-gray-200 h-4 rounded">
    <div id="progressBar" class="h-4 bg-green-500 rounded w-0 transition-all"></div>
  </div>
</div>

<!-- Quiz Container -->
<div id="quizContainer" class="mt-6 grid gap-4"></div>

<!-- Navigation + Bookmark -->
<div class="mt-4 flex justify-between hidden" id="navButtons">
  <button id="prevBtn" class="bg-gray-300 px-4 py-1 rounded hover:bg-gray-400">Previous</button>
  <button id="nextBtn" class="bg-gray-300 px-4 py-1 rounded hover:bg-gray-400">Next</button>
</div>
<div class="mt-2 text-center">
  <button id="bookmarkBtn" class="bg-yellow-400 px-4 py-1 rounded hidden hover:bg-yellow-500">Bookmark</button>
</div>
<div class="mt-4 text-center">
  <button id="submitBtn" class="bg-green-500 text-white px-6 py-2 rounded hidden hover:bg-green-600">Submit Quiz</button>
</div>

<!-- Topic Chart -->
<div id="topicChartContainer" class="mt-6 p-4 bg-white shadow-lg rounded-lg" style="display:none;">
  <h2 class="text-xl font-bold mb-2 text-gray-700">Topic-wise Performance</h2>
  <canvas id="topicChart"></canvas>
</div>

<!-- AI Summary -->
<div id="aiSummaryCard" class="mt-6 p-4 bg-green-50 border-l-4 border-green-500 rounded-lg shadow-lg" style="display:none;">
  <h2 class="font-bold text-lg mb-2 text-green-700">AI Study Recommendations</h2>
  <p id="aiSummaryText" class="text-gray-800"></p>
</div>

<script>
let quizData=[], currentQuestion=0, answers={}, bookmarks=[];
const examSelect=document.getElementById("examSelect");
const subtopicSelect=document.getElementById("subtopicSelect");
const quizContainer=document.getElementById("quizContainer");
const loadBtn=document.getElementById("loadBtn");
const prevBtn=document.getElementById("prevBtn");
const nextBtn=document.getElementById("nextBtn");
const submitBtn=document.getElementById("submitBtn");
const bookmarkBtn=document.getElementById("bookmarkBtn");
const navButtons=document.getElementById("navButtons");
const progressBar=document.getElementById("progressBar");
const liveScore=document.getElementById("liveScore");

// Load subtopics
function loadSubtopics(){
  fetch(`/get_subtopics/${examSelect.value}`)
    .then(res=>res.json())
    .then(data=>{
      subtopicSelect.innerHTML="";
      data.forEach(s=>{
        const opt=document.createElement("option");
        opt.value=s; opt.innerText=s;
        subtopicSelect.appendChild(opt);
      });
    });
}
examSelect.addEventListener("change", loadSubtopics);
window.onload=loadSubtopics;

// Load Quiz
loadBtn.addEventListener("click",()=>{
  fetch(`/get-quiz/${examSelect.value}/${subtopicSelect.value}`)
    .then(res=>res.json())
    .then(data=>{
      quizData=data;
      currentQuestion=0; answers={}; bookmarks=[];
      renderQuestion();
      navButtons.classList.remove("hidden");
      submitBtn.classList.remove("hidden");
      bookmarkBtn.classList.remove("hidden");
      updateProgressBar();
      updateLiveScore();
    });
});

// Render Question
function renderQuestion(){
  const q=quizData[currentQuestion];
  let html=`<div class="p-4 border rounded shadow-lg bg-white card">
              <div class="flex justify-between items-center">
                <p class="font-semibold text-lg">Q${currentQuestion+1}: ${q.question}</p>
                <span class="px-2 py-1 rounded bg-blue-100 text-blue-800">${bookmarks.includes(currentQuestion)?"Bookmarked":""}</span>
              </div>`;
  q.options.forEach(option=>{
    const checked=answers[currentQuestion]===option?"checked":"";
    html+=`<label class="block mt-2 p-2 border rounded cursor-pointer hover:bg-gray-100 ${answers[currentQuestion]===option?'bg-blue-50 border-blue-400':''}">
              <input type="radio" name="q${currentQuestion}" value="${option}" ${checked} class="mr-2">${option}
           </label>`;
  });
  html+="</div>";
  quizContainer.innerHTML=html;
  speakQuestion(q.question);
  highlightBookmark();
}

// Navigation
prevBtn.addEventListener("click",()=>{ saveAnswer(); if(currentQuestion>0){currentQuestion--; renderQuestion();}});
nextBtn.addEventListener("click",()=>{ saveAnswer(); if(currentQuestion<quizData.length-1){currentQuestion++; renderQuestion();}});
function saveAnswer(){ const selected=document.querySelector(`input[name='q${currentQuestion}']:checked`); answers[currentQuestion]=selected?selected.value:""; updateProgressBar(); updateLiveScore();}

// Progress & Live Score
function updateProgressBar(){ let percent=(Object.keys(answers).length/quizData.length)*100; progressBar.style.width=percent+"%";}
function updateLiveScore(){ let score=0; for(let i=0;i<quizData.length;i++){ if(answers[i]===quizData[i].answer) score++;} liveScore.innerText=`Score: ${score} / ${quizData.length}`;}

// Bookmark
bookmarkBtn.addEventListener("click",()=>{ if(!bookmarks.includes(currentQuestion)) bookmarks.push(currentQuestion); highlightBookmark();});
function highlightBookmark(){ if(bookmarks.includes(currentQuestion)) bookmarkBtn.classList.add("bg-yellow-600"); else bookmarkBtn.classList.remove("bg-yellow-600");}

// Submit
submitBtn.addEventListener("click",()=>{
  saveAnswer();
  fetch(`/submit/${examSelect.value}/${subtopicSelect.value}`, {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(answers)
  }).then(res=>res.json()).then(data=>{
    renderResultCards();
    renderTopicChart(data.incorrect_questions);
    document.getElementById("aiSummaryText").innerText=data.ai_summary;
    document.getElementById("aiSummaryCard").style.display="block";
  });
});

// Render Result Cards
function renderResultCards(){
  quizContainer.innerHTML="";
  quizData.forEach((q,i)=>{
    let color=answers[i]===q.answer?"bg-green-100 border-green-400":"bg-red-100 border-red-400";
    quizContainer.innerHTML+=`<div class="p-4 border-l-4 ${color} rounded shadow-lg mb-2">
        <p class="font-semibold">Q${i+1}: ${q.question}</p>
        <p>Your Answer: ${answers[i]||"Not Answered"}</p>
        <p>Correct Answer: ${q.answer}</p>
      </div>`;
  });
}

// Topic Chart
function renderTopicChart(incorrectQuestions){
  const topicCounts={};
  quizData.forEach((q,i)=>{ let topic=subtopicSelect.value; if(!topicCounts[topic]) topicCounts[topic]=0; if(answers[i]!==q.answer) topicCounts[topic]++;});
  const ctx=document.getElementById("topicChart").getContext("2d");
  new Chart(ctx,{ type:'bar', data:{ labels:Object.keys(topicCounts), datasets:[{ label:'Incorrect Questions', data:Object.values(topicCounts), backgroundColor:'rgba(255,99,132,0.6)' }] }, options:{responsive:true, plugins:{legend:{display:false}}} });
  document.getElementById("topicChartContainer").style.display="block";
}

// TTS
function speakQuestion(text){ if('speechSynthesis' in window){ const msg=new SpeechSynthesisUtterance(text); window.speechSynthesis.speak(msg);}}
</script>

</div>
</body>
</html>
