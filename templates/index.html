<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Quizroom Academy</title>

<!-- Tailwind (CDN) -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Google Font -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
  :root{
    --glass-bg: rgba(255,255,255,0.14);
    --glass-border: rgba(255,255,255,0.18);
    --card-radius: 14px;
    --max-width: 1100px;
  }
  html,body { height:100%; font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
  body { margin:0; background-size:400% 400%; transition: background 600ms ease; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }

  /* Glass panel */
  .glass {
    background: var(--glass-bg);
    backdrop-filter: blur(10px) saturate(120%);
    -webkit-backdrop-filter: blur(10px) saturate(120%);
    border: 1px solid var(--glass-border);
  }

  /* Card hover */
  .card-hover { transition: transform .22s cubic-bezier(.2,.9,.3,1), box-shadow .22s ease; }
  .card-hover:hover { transform: translateY(-6px) scale(1.01); box-shadow:0 20px 40px rgba(2,6,23,0.12); }

  /* Small buttons */
  .btn-sm { padding:.5rem .75rem; border-radius:8px; }

  /* Floating live score */
  #liveBadge { position: fixed; right: 16px; top: 16px; z-index:60; box-shadow: 0 10px 30px rgba(2,6,23,0.12); }

  /* Responsive layout adjustments */
  .app-max { max-width: var(--max-width); }

  /* Background animations for themes */
  .bg-upsc { background: linear-gradient(120deg,#0ea5e9 0%,#3b82f6 40%,#60a5fa 100%); animation: move 12s ease infinite; }
  .bg-neet { background: linear-gradient(120deg,#7c3aed 0%,#d946ef 45%,#a78bfa 100%); animation: move 14s ease infinite; }
  .bg-ssc  { background: linear-gradient(120deg,#16a34a 0%,#22c55e 45%,#bbf7d0 100%); animation: move 11s ease infinite; }
  @keyframes move { 0% { background-position:0% 50% } 50% { background-position:100% 50% } 100% { background-position:0% 50% } }

  /* Option button mobile-friendly */
  .option-btn { width:100%; display:block; text-align:left; }

  /* Ad placeholder */
  .ad-slot { background: linear-gradient(90deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03)); border: 1px dashed rgba(255,255,255,0.08); padding:8px; border-radius:8px; color:rgba(255,255,255,0.8); }

  /* result styles */
  .result-correct { background: rgba(16,185,129,0.12); border-left: 4px solid rgba(16,185,129,0.9); }
  .result-wrong { background: rgba(239,68,68,0.08); border-left: 4px solid rgba(239,68,68,0.9); }

  /* small screens tweak */
  @media (max-width: 880px) {
    .sidebar { display:none; }
    .app-max { padding: 1rem; }
  }
</style>
</head>

<body class="min-h-screen bg-upsc">

<!-- NAVBAR -->
<header class="w-full glass sticky top-0 z-50">
  <div class="app-max mx-auto flex items-center justify-between px-4 py-3">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 rounded-lg bg-white/20 flex items-center justify-center text-white font-bold">QA</div>
      <div>
        <div class="text-white font-semibold text-lg">Quizroom Academy</div>
        <div class="text-white/80 text-xs">Smart MCQ practice for students</div>
      </div>
    </div>

    <div class="flex items-center gap-3">
      <button id="themeToggle" class="text-white bg-white/10 px-3 py-1 rounded btn-sm">Toggle Theme</button>
    </div>
  </div>
</header>

<!-- MAIN -->
<main class="app-max mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6 px-4 py-6">

  <!-- LEFT / MAIN COLUMN -->
  <section class="lg:col-span-2 space-y-4">

    <!-- Exam selector card -->
    <div class="glass p-4 rounded-xl card-hover">
      <div class="flex flex-col sm:flex-row sm:items-center sm:gap-3 justify-between">
        <div class="flex flex-wrap gap-3 items-center">
          <div class="flex items-center gap-2">
            <label class="text-white font-medium">Exam</label>
            <select id="examSelect" class="rounded-md px-3 py-2 text-sm" aria-label="Select exam">
              <option value="upsc">UPSC</option>
              <option value="neet_pg">NEET PG</option>
              <option value="ssc">SSC</option>
            </select>
          </div>

          <div class="flex items-center gap-2">
            <label class="text-white font-medium">Year / Topic</label>
            <select id="subtopicSelect" class="rounded-md px-3 py-2 text-sm" aria-label="Select subtopic"></select>
          </div>

          <button id="loadBtn" class="ml-2 bg-white text-gray-800 px-4 py-2 rounded-md font-semibold hover:scale-105">Load Quiz</button>
        </div>

        <div class="flex gap-2 mt-3 sm:mt-0">
          <button id="ttsToggle" class="bg-white/10 text-white px-3 py-2 rounded-md btn-sm">ðŸ”Š TTS</button>
          <button id="bookmarkListBtn" class="bg-white/10 text-white px-3 py-2 rounded-md btn-sm">â˜… Bookmarks</button>
        </div>
      </div>
    </div>

    <!-- QUIZ CARD -->
    <div id="quizArea" class="space-y-4">
      <!-- question cards injected here -->
      <div id="quizContainer" class="space-y-4"></div>

      <!-- nav & submit -->
      <div id="controls" class="flex flex-wrap gap-3 items-center justify-between">
        <div class="flex gap-2">
          <button id="prevBtn" class="bg-white/10 text-white px-4 py-2 rounded-md">Previous</button>
          <button id="nextBtn" class="bg-white/10 text-white px-4 py-2 rounded-md">Next</button>
        </div>

        <div class="flex items-center gap-3">
          <button id="bookmarkBtn" class="hidden bg-yellow-400 text-black px-4 py-2 rounded-md">Bookmark</button>
          <button id="submitBtn" class="hidden bg-green-500 text-white px-4 py-2 rounded-md">Submit</button>
        </div>
      </div>
    </div>

    <!-- Result / AI summary area -->
    <div id="resultArea" class="space-y-4">
      <div id="resultHeader" class="hidden glass p-4 rounded-xl">
        <div class="flex items-center justify-between">
          <div>
            <div id="scoreText" class="text-white text-lg font-semibold">Your Score: 0 / 0</div>
            <div id="badgeText" class="text-white/80 text-sm mt-1">Badge: â€”</div>
          </div>
          <div class="text-right">
            <button id="reviewWrongBtn" class="bg-white/10 text-white px-3 py-1 rounded btn-sm">Review Wrong</button>
            <button id="downloadSummaryBtn" class="bg-white/10 text-white px-3 py-1 rounded btn-sm">Download</button>
          </div>
        </div>
      </div>

      <div id="resultsList" class="space-y-2"></div>

      <div id="aiSummaryCard" class="hidden glass p-4 rounded-xl">
        <h3 class="text-white font-semibold mb-2">AI Study Recommendations</h3>
        <div id="aiSummaryText" class="text-white/90 text-sm"></div>
      </div>
    </div>

    <!-- bottom ad placeholder (mobile) -->
    <div class="lg:hidden mt-4">
      <div class="ad-slot text-center py-3 rounded-md">Ad slot (mobile bottom) â€” reserved</div>
    </div>
  </section>

  <!-- RIGHT / SIDEBAR -->
  <aside class="sidebar lg:col-span-1 space-y-4">
    <!-- live score floating (desktop) -->
    <div id="liveBadge" class="hidden lg:block glass p-3 rounded-xl" style="position:sticky; top:90px;">
      <div class="text-white font-semibold">Live Score</div>
      <div id="liveScore" class="text-white/90 text-sm">0 / 0</div>
      <div class="w-36 h-3 bg-white/20 rounded mt-2 overflow-hidden">
        <div id="progressBar" class="h-3 bg-green-400 rounded w-0 transition-all"></div>
      </div>
    </div>

    <!-- topic chart -->
    <div id="topicChartContainer" class="glass p-4 rounded-xl hidden">
      <h4 class="text-white font-semibold mb-2">Topic performance</h4>
      <canvas id="topicChart"></canvas>
    </div>

    <!-- bookmarks panel -->
    <div id="bookmarkPanel" class="glass p-4 rounded-xl hidden">
      <h4 class="text-white font-semibold mb-2">Bookmarked Qs</h4>
      <div id="bookmarkList" class="text-white/90 text-sm space-y-1"></div>
    </div>

    <!-- ad placeholder desktop -->
    <div class="glass p-3 rounded-xl text-white text-sm ad-slot">
      Ad slot (desktop) â€” 300x250
    </div>
  </aside>

</main>

<!-- FOOTER / sticky ad -->
<footer class="fixed left-0 right-0 bottom-0 lg:hidden p-2 z-40">
  <div class="mx-auto max-w-md text-center">
    <div class="ad-slot">Bottom Ad placeholder â€” reserve spacing</div>
  </div>
</footer>

<!-- SCRIPT: app logic -->
<script>
/* ========= App state ========= */
let quizData = [];
let currentQuestion = 0;
let answers = {};         // { index: option }
let bookmarks = [];       // array of question indices
let ttsEnabled = true;
let activeTheme = 'upsc';

/* DOM refs */
const examSelect = document.getElementById('examSelect');
const subtopicSelect = document.getElementById('subtopicSelect');
const loadBtn = document.getElementById('loadBtn');
const quizContainer = document.getElementById('quizContainer');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const submitBtn = document.getElementById('submitBtn');
const bookmarkBtn = document.getElementById('bookmarkBtn');
const bookmarkListBtn = document.getElementById('bookmarkListBtn');
const bookmarkPanel = document.getElementById('bookmarkPanel');
const bookmarkList = document.getElementById('bookmarkList');
const topicChartContainer = document.getElementById('topicChartContainer');
const aiSummaryCard = document.getElementById('aiSummaryCard');
const aiSummaryText = document.getElementById('aiSummaryText');
const resultHeader = document.getElementById('resultHeader');
const resultsList = document.getElementById('resultsList');
const scoreText = document.getElementById('scoreText');
const badgeText = document.getElementById('badgeText');
const liveScoreEls = document.querySelectorAll('#liveScore');
const progressBarEls = document.querySelectorAll('#progressBar');
const ttsToggle = document.getElementById('ttsToggle');
const themeToggle = document.getElementById('themeToggle');
const reviewWrongBtn = document.getElementById('reviewWrongBtn');
const downloadSummaryBtn = document.getElementById('downloadSummaryBtn');

/* Chart instance */
let topicChart = null;

/* Theme backgrounds */
const themeMap = {
  upsc: 'bg-upsc',
  neet_pg: 'bg-neet',
  ssc: 'bg-ssc'
};

/* ================= Init ================= */
function init() {
  loadSubtopics();
  examSelect.addEventListener('change', onExamChange);
  loadBtn.addEventListener('click', onLoadQuiz);
  prevBtn.addEventListener('click', onPrev);
  nextBtn.addEventListener('click', onNext);
  submitBtn.addEventListener('click', onSubmit);
  bookmarkBtn.addEventListener('click', onBookmarkCurrent);
  bookmarkListBtn.addEventListener('click', toggleBookmarkPanel);
  ttsToggle.addEventListener('click', ()=>{ ttsEnabled = !ttsEnabled; ttsToggle.textContent = ttsEnabled? 'ðŸ”Š TTS' : 'ðŸ”ˆ TTS'; });
  themeToggle.addEventListener('click', ()=>{ document.body.classList.toggle('invert'); });
  reviewWrongBtn.addEventListener('click', reviewWrongQuestions);
  downloadSummaryBtn.addEventListener('click', downloadSummary);
}
init();

/* ========= Subtopics ========= */
function loadSubtopics(){
  fetch(`/get_subtopics/${examSelect.value}`)
    .then(r=>r.json())
    .then(list=>{
      subtopicSelect.innerHTML = '';
      if(!list || list.length===0){ subtopicSelect.innerHTML = '<option value="">No topics</option>'; return; }
      list.forEach(s=>{
        const opt = document.createElement('option'); opt.value = s; opt.innerText = s; subtopicSelect.appendChild(opt);
      });
    });
}

function onExamChange(e){
  const exam = examSelect.value;
  // Update background theme
  Object.values(themeMap).forEach(c=> document.body.classList.remove(c));
  const themeClass = themeMap[exam] || themeMap.upsc;
  document.body.classList.add(themeClass);
  // Load subtopics for new exam
  loadSubtopics();
}

/* ========= Load quiz ========= */
function onLoadQuiz(){
  const exam = examSelect.value;
  const sub = subtopicSelect.value;
  if(!sub){ alert('Select a year/topic'); return; }
  fetch(`/get-quiz/${exam}/${sub}`)
    .then(r => r.json())
    .then(data => {
      quizData = data || [];
      currentQuestion = 0;
      answers = {};
      bookmarks = [];
      renderQuestion();
      // show controls
      document.getElementById('controls').classList.remove('hidden');
      bookmarkBtn.classList.remove('hidden');
      submitBtn.classList.remove('hidden');
      // hide previous result sections
      document.getElementById('resultsList').innerHTML = '';
      aiSummaryCard.classList.add('hidden');
      topicChartContainer.classList.add('hidden');
      resultHeader.classList.add('hidden');
      // update UI
      updateProgress();
      updateLiveScore();
      updateBookmarkPanel();
    })
    .catch(err=>{
      console.error(err);
      alert('Failed to load quiz');
    });
}

/* ========= Render question card ========= */
function renderQuestion(){
  if(!quizData || quizData.length===0){
    quizContainer.innerHTML = `<div class="glass p-4 rounded-xl text-white/90">No questions found for this selection.</div>`;
    return;
  }
  const q = quizData[currentQuestion];
  // mobile-friendly option buttons
  let html = `<div class="glass p-4 rounded-xl card-hover text-white">
        <div class="flex justify-between items-start mb-2">
          <div>
            <div class="text-sm text-white/80">Question ${currentQuestion+1} of ${quizData.length}</div>
            <h3 class="text-lg font-semibold mt-1">${escapeHtml(q.question)}</h3>
          </div>
          <div class="text-right">
            <div class="text-xs text-white/70 mb-1">${bookmarks.includes(currentQuestion)? 'â˜… Bookmarked' : ''}</div>
            <div class="text-xs text-white/70">Difficulty: ${q.difficulty || 'â€”'}</div>
          </div>
        </div>
        <div class="grid gap-2">`;

  q.options.forEach(opt=>{
    const isChecked = answers[currentQuestion] === opt ? 'ring-2 ring-white/30 bg-white/5' : '';
    html += `<button data-value="${escapeAttr(opt)}" class="option-btn text-left option-item glass p-3 rounded-md ${isChecked}">
        <div class="flex items-center gap-3">
          <div class="w-6 h-6 rounded-full border border-white/25 flex items-center justify-center text-sm text-white/90">${opt[0] ? opt[0].toUpperCase() : ''}</div>
          <div class="flex-1 text-white">${escapeHtml(opt)}</div>
        </div>
      </button>`;
  });

  // audio + hint row
  html += `</div>
      <div class="flex items-center justify-between mt-3">
        <div class="flex gap-2">
          <button id="playQ" class="bg-white/10 text-white px-3 py-1 rounded btn-sm">Play</button>
          ${q.hint ? `<button id="hintBtn" class="bg-white/10 text-white px-3 py-1 rounded btn-sm">Hint</button>` : ''}
        </div>
        <div class="text-sm text-white/80">Topic: ${q.topic || subtopicSelect.value}</div>
      </div>
    </div>`;

  quizContainer.innerHTML = html;

  // attach option listeners
  document.querySelectorAll('.option-item').forEach(btn=>{
    btn.addEventListener('click', (ev)=>{
      const val = ev.currentTarget.getAttribute('data-value');
      answers[currentQuestion] = val;
      // visual toggle
      document.querySelectorAll('.option-item').forEach(el => el.classList.remove('ring-2','ring-white/30','bg-white/5'));
      ev.currentTarget.classList.add('ring-2','ring-white/30','bg-white/5');
      updateProgress();
      updateLiveScore();
    });
  });

  // play & hint
  const playBtn = document.getElementById('playQ');
  playBtn && playBtn.addEventListener('click', ()=> speakText(q.question));

  const hintBtn = document.getElementById('hintBtn');
  hintBtn && hintBtn.addEventListener('click', ()=>{
    alert(q.hint || 'No hint available');
  });

  // highlight bookmark state UI
  if(bookmarks.includes(currentQuestion)) bookmarkBtn.classList.add('bg-yellow-600'); else bookmarkBtn.classList.remove('bg-yellow-600');
}

/* ========= Navigation ========= */
function onPrev(){ if(currentQuestion>0){ currentQuestion--; renderQuestion(); } }
function onNext(){ if(currentQuestion < quizData.length - 1){ currentQuestion++; renderQuestion(); } }

/* ========= Bookmark ========= */
function onBookmarkCurrent(){
  if(!bookmarks.includes(currentQuestion)) bookmarks.push(currentQuestion);
  updateBookmarkPanel();
  bookmarkBtn.classList.add('bg-yellow-600');
}
function updateBookmarkPanel(){
  bookmarkList.innerHTML = '';
  if(bookmarks.length===0){ bookmarkList.innerHTML = '<div class="text-white/80 text-sm">No bookmarks</div>'; return; }
  bookmarks.forEach(i=>{
    const q = quizData[i];
    const el = document.createElement('div');
    el.className = 'text-white/90 text-sm py-1 border-b border-white/6';
    el.innerHTML = `<div class="flex justify-between items-center"><div class="flex-1 pr-2">${i+1}. ${escapeHtml(q.question)}</div>
      <div><button data-i="${i}" class="text-xs bg-white/10 px-2 py-1 rounded">Go</button></div></div>`;
    bookmarkList.appendChild(el);
  });
  // attach go handlers
  bookmarkList.querySelectorAll('button').forEach(btn=>{
    btn.addEventListener('click', e=>{ const i = Number(e.currentTarget.getAttribute('data-i')); currentQuestion = i; renderQuestion(); toggleBookmarkPanel(); });
  });
}
function toggleBookmarkPanel(){ bookmarkPanel.classList.toggle('hidden'); }

/* ========= Progress & Live Score ========= */
function updateProgress(){
  const answeredCount = Object.keys(answers).length;
  const percent = quizData.length ? Math.round((answeredCount / quizData.length) * 100) : 0;
  progressBarEls.forEach(pb => pb.style.width = percent + '%');
}
function updateLiveScore(){
  let score = 0;
  for(let i=0;i<quizData.length;i++){
    if(answers[i] && quizData[i] && answers[i] === quizData[i].answer) score++;
  }
  liveScoreEls.forEach(el => el.innerText = `${score} / ${quizData.length}`);
  // small top badge on header too
  document.querySelectorAll('#liveScore').forEach(el=> el.innerText = `${score} / ${quizData.length}`);
}

/* ========= Submit & Results ========= */
function onSubmit(){
  // ensure at least one answer or confirmation
  if(Object.keys(answers).length === 0 && !confirm('You have not answered any questions. Submit anyway?')) return;

  // send answers to backend
  const exam = examSelect.value, sub = subtopicSelect.value;
  fetch(`/submit/${exam}/${sub}`, {
    method:'POST',
    headers:{ 'Content-Type':'application/json' },
    body: JSON.stringify(answers)
  }).then(r=>r.json()).then(res=>{
    // show results header
    resultHeader.classList.remove('hidden');
    scoreText.innerText = `Your Score: ${res.score} / ${res.total}`;
    // badge logic
    const pct = res.total? (res.score / res.total) * 100 : 0;
    let badge = 'Keep Practicing';
    if(pct === 100) badge = 'Perfect âœ…';
    else if(pct >= 80) badge = 'Great ðŸ¥‡';
    else if(pct >= 50) badge = 'Good ðŸ‘';
    badgeText.innerText = `Badge: ${badge}`;
    // render result cards
    renderResults(res);
    // AI summary
    aiSummaryText.innerText = res.ai_summary || 'â€”';
    aiSummaryCard.classList.remove('hidden');
    // chart
    renderTopicChart(res.incorrect_questions || []);
  }).catch(e=>{ console.error(e); alert('Submit failed'); });
}

function renderResults(res){
  resultsList.innerHTML = '';
  quizData.forEach((q,i)=>{
    const correct = answers[i] === q.answer;
    const div = document.createElement('div');
    div.className = `p-3 rounded-md ${correct? 'result-correct' : 'result-wrong' }`;
    div.innerHTML = `<div class="flex justify-between items-start">
        <div class="flex-1">
          <div class="font-semibold text-white">Q${i+1}. ${escapeHtml(q.question)}</div>
          <div class="text-white/90 mt-1">Your Answer: <span class="font-medium">${escapeHtml(answers[i] || 'Not answered')}</span></div>
          ${!correct? `<div class="text-white/90 mt-1">Correct: <span class="font-medium">${escapeHtml(q.answer)}</span></div>` : ''}
        </div>
      </div>`;
    resultsList.appendChild(div);
  });
}

/* ========= Chart ========= */
function renderTopicChart(incorrectQuestions){
  // simple mapping: group by subtopic (for now, single subtopic)
  const label = subtopicSelect.value || 'Topic';
  const wrongCount = (Array.isArray(incorrectQuestions) ? incorrectQuestions.length : 0);
  // create/destroy chart
  if(topicChart) topicChart.destroy();
  const ctx = document.getElementById('topicChart').getContext('2d');
  topicChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['Correct', 'Incorrect'],
      datasets: [{
        data: [quizData.length - wrongCount, wrongCount],
        backgroundColor: ['#34d399','#fb7185']
      }]
    },
    options: { responsive:true, plugins:{ legend:{ position:'bottom', labels:{ color: '#fff' } } } }
  });
  topicChartContainer.classList.remove('hidden');
  // also show sidebar bookmark panel (desktop)
  bookmarkPanel.classList.remove('hidden');
}

/* ========= Utility: TTS ========= */
function speakText(txt){
  if(!ttsEnabled) return;
  if('speechSynthesis' in window){
    try{
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(txt);
      u.rate = 0.95; u.pitch = 1.0; u.lang = 'en-GB';
      window.speechSynthesis.speak(u);
    }catch(e){ console.warn('TTS err', e); }
  }
}

/* ========= Review wrong ========= */
function reviewWrongQuestions(){
  // jump to first wrong
  for(let i=0;i<quizData.length;i++){
    if(answers[i] !== quizData[i].answer){ currentQuestion = i; renderQuestion(); return; }
  }
  alert('No wrong questions to review.');
}

/* ========= Download summary (simple text) ========= */
function downloadSummary(){
  let text = scoreText.innerText + '\n\n';
  text += 'Detailed results:\n';
  quizData.forEach((q,i)=> {
    text += `Q${i+1}: ${q.question}\nYour: ${answers[i] || 'Not answered'}\nCorrect: ${q.answer}\n\n`;
  });
  const blob = new Blob([text], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'quiz_summary.txt'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

/* ========= Helpers ========= */
function escapeHtml(s){ if(!s) return ''; return s.replaceAll && s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
function escapeAttr(s){ return (s||'').replaceAll('"','&quot;').replaceAll("'",'&#39;'); }

</script>
</body>
</html>
