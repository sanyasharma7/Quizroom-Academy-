<!DOCTYPE html>
<html lang="en" class="dark">
<head>
<meta charset="UTF-8">
<title>Quizroom Academy</title>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Google Font -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
body { font-family: 'Inter', sans-serif; transition: background .4s, color .4s; }
.card:hover { transform: scale(1.03); transition: .3s; }
</style>

<script>
// Tailwind dark mode
tailwind.config = { darkMode: 'class' }
</script>
</head>

<body class="bg-gray-50 dark:bg-gray-900 p-6 text-gray-900 dark:text-gray-200">

<div class="max-w-5xl mx-auto bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">

<!-- Header -->
<div class="flex justify-between items-center mb-2">
  <h1 class="text-3xl font-bold text-blue-700 dark:text-blue-300">Quizroom Academy</h1>

  <button id="themeToggle" class="px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600">
    ðŸŒ™ Night Mode
  </button>
</div>

<!-- Exam & Topic Select -->
<div class="mb-4 text-center flex flex-wrap justify-center items-center gap-3">
  <label class="font-semibold">Select Exam:</label>
  <select id="examSelect" class="border rounded px-3 py-1 dark:bg-gray-700 dark:border-gray-600">
    <option value="upsc">UPSC</option>
    <option value="neet_pg">NEET PG</option>
    <option value="ssc">SSC</option>
  </select>

  <label class="font-semibold ml-2">Select Year / Topic:</label>
  <select id="subtopicSelect" class="border rounded px-3 py-1 dark:bg-gray-700 dark:border-gray-600"></select>

  <button id="loadBtn" class="bg-blue-500 text-white px-4 py-1 rounded hover:bg-blue-600">Load Quiz</button>
</div>

<!-- Score + Progress -->
<div class="flex justify-between items-center mb-4">
  <div id="liveScore" class="text-lg font-semibold text-blue-700 dark:text-blue-300">Score: 0</div>
  <div class="w-1/2 bg-gray-200 dark:bg-gray-700 h-4 rounded">
    <div id="progressBar" class="h-4 bg-green-500 rounded w-0 transition-all"></div>
  </div>
</div>

<!-- Quiz Container -->
<div id="quizContainer" class="mt-6 grid gap-4"></div>

<!-- Navigation -->
<div class="mt-4 flex justify-between hidden" id="navButtons">
  <button id="prevBtn" class="bg-gray-300 dark:bg-gray-700 px-4 py-1 rounded hover:bg-gray-400 dark:hover:bg-gray-600">Previous</button>
  <button id="nextBtn" class="bg-gray-300 dark:bg-gray-700 px-4 py-1 rounded hover:bg-gray-400 dark:hover:bg-gray-600">Next</button>
</div>

<!-- Submit Button -->
<div class="mt-4 text-center">
  <button id="submitBtn" class="bg-green-500 text-white px-6 py-2 rounded hidden hover:bg-green-600">Submit Quiz</button>
</div>

<!-- Chart -->
<div id="topicChartContainer" class="mt-6 p-4 bg-white dark:bg-gray-800 shadow-lg rounded-lg hidden">
  <h2 class="text-xl font-bold mb-2 text-gray-700 dark:text-gray-300">Topic-wise Performance</h2>
  <canvas id="topicChart"></canvas>
</div>

<!-- AI Summary -->
<div id="aiSummaryCard" class="mt-6 p-4 bg-green-50 dark:bg-green-900 border-l-4 border-green-500 rounded-lg shadow-lg hidden">
  <h2 class="font-bold text-lg mb-2 text-green-700 dark:text-green-300">AI Study Recommendations</h2>
  <p id="aiSummaryText"></p>
</div>

<script>
let quizData=[], currentQuestion=0, answers={};

// ðŸŒ™ Theme Toggle
const themeBtn = document.getElementById("themeToggle");
themeBtn.onclick = () => {
  document.documentElement.classList.toggle("dark");
  themeBtn.textContent = document.documentElement.classList.contains("dark")
    ? "â˜€ï¸ Day Mode"
    : "ðŸŒ™ Night Mode";
};

// ðŸ“¢ Text-to-Speech
function speakQuestion(text){
  if ('speechSynthesis' in window){
      window.speechSynthesis.cancel();
      const msg = new SpeechSynthesisUtterance(text);
      msg.rate = 1;
      msg.pitch = 1;
      msg.volume = 1;
      window.speechSynthesis.speak(msg);
  }
}

// Load subtopics
function loadSubtopics(){
  fetch(`/get_subtopics/${examSelect.value}`)
    .then(r=>r.json())
    .then(data=>{
      subtopicSelect.innerHTML="";
      data.forEach(s=>{
        const opt=document.createElement("option");
        opt.value=s; opt.innerText=s;
        subtopicSelect.appendChild(opt);
      });
    });
}
examSelect.onchange=loadSubtopics;
window.onload=loadSubtopics;

// Load quiz
loadBtn.onclick = () => {
  fetch(`/get-quiz/${examSelect.value}/${subtopicSelect.value}`)
  .then(r=>r.json())
  .then(data=>{
    quizData=data; currentQuestion=0; answers={};
    renderQuestion();
    navButtons.classList.remove("hidden");
    submitBtn.classList.remove("hidden");
    updateProgress(); updateScore();
  });
};

// Render Question
function renderQuestion(){
  const q = quizData[currentQuestion];
  let html = `<div class="p-4 border rounded shadow-lg bg-white dark:bg-gray-700 card">
              <p class="font-semibold text-lg">Q${currentQuestion+1}: ${q.question}</p>`;

  q.options.forEach(option=>{
    const checked = answers[currentQuestion]===option ? "checked" : "";
    html+=`<label class="block mt-2 p-2 border rounded cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600 ${checked?'bg-blue-100 dark:bg-blue-700':''}">
            <input type="radio" name="q${currentQuestion}" value="${option}" ${checked} class="mr-2">${option}
           </label>`;
  });

  html+="</div>";
  quizContainer.innerHTML = html;

  // ðŸ”Š Speak Question
  speakQuestion(q.question);
}

// Navigation
prevBtn.onclick = ()=>{ saveAnswer(); if(currentQuestion>0){currentQuestion--; renderQuestion();}};
nextBtn.onclick = ()=>{ saveAnswer(); if(currentQuestion<quizData.length-1){currentQuestion++; renderQuestion();}};

function saveAnswer(){
  const s=document.querySelector(`input[name='q${currentQuestion}']:checked`);
  answers[currentQuestion]=s?s.value:"";
  updateProgress(); updateScore();
}

// Progress + Live Score
function updateProgress(){
  let percent=(Object.keys(answers).length/quizData.length)*100;
  progressBar.style.width = percent+"%";
}
function updateScore(){
  let score=0; quizData.forEach((q,i)=>{ if(answers[i]===q.answer) score++; });
  liveScore.textContent = `Score: ${score} / ${quizData.length}`;
}

// Submit Quiz
submitBtn.onclick = ()=>{
  saveAnswer();
  fetch(`/submit/${examSelect.value}/${subtopicSelect.value}`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(answers)
  }).then(r=>r.json()).then(data=>{
    showResults();
    drawChart(data.incorrect_questions);
    aiSummaryText.textContent=data.ai_summary;
    aiSummaryCard.classList.remove("hidden");
  });
};

// Show results
function showResults(){
  quizContainer.innerHTML="";
  quizData.forEach((q,i)=>{
    let correct = answers[i]===q.answer;
    let color = correct ? "bg-green-100 dark:bg-green-800 border-green-400" : "bg-red-100 dark:bg-red-800 border-red-400";
    quizContainer.innerHTML+=`<div class="p-4 border-l-4 ${color} rounded shadow-lg mb-2">
        <p class="font-semibold">Q${i+1}: ${q.question}</p>
        <p>Your Answer: ${answers[i]||"Not Answered"}</p>
        <p>Correct Answer: ${q.answer}</p>
      </div>`;
  });
}

// Chart
function drawChart(incorrect){
  const ctx=document.getElementById("topicChart").getContext("2d");
  new Chart(ctx,{
    type:'bar',
    data:{
      labels:[subtopicSelect.value],
      datasets:[{
        label:'Incorrect Questions',
        data:[incorrect.length],
        backgroundColor:['rgba(75, 192, 192, 0.7)'],
        borderRadius:10
      }]
    },
    options:{
      responsive:true,
      scales:{ y:{ beginAtZero:true, grid:{display:true}}, x:{grid:{display:false}} }
    }
  });
  topicChartContainer.classList.remove("hidden");
}
</script>

</div>
</body>
</html>
